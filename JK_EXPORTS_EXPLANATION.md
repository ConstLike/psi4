# JK Python Exports - –ü–æ—á–µ–º—É —ç—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–ª—è Multi-Cycle SCF

**–î–∞—Ç–∞:** 2025-11-13
**–°—Ç–∞—Ç—É—Å:** –ù–ï–û–ë–•–û–î–ò–ú–ê–Ø —á–∞—Å—Ç—å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ multi-cycle SCF

---

## –í–æ–ø—Ä–æ—Å

> "–≠—Ç–æ –º—ã —á—Ç–æ-—Ç–æ –¥–µ–ª–∞–µ–º –Ω–µ —Ç–∞–∫, –∏–ª–∏ —ç—Ç–æ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ –¥–ª—è multi SCF?"

## –û—Ç–≤–µ—Ç

**–≠—Ç–æ –ê–ë–°–û–õ–Æ–¢–ù–û –ù–ï–û–ë–•–û–î–ò–ú–û–ï —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ –¥–ª—è multi-cycle SCF.** –≠—Ç–æ –Ω–µ –æ—à–∏–±–∫–∞, –∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è —á–∞—Å—Ç—å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏.

---

## –ü–æ—á–µ–º—É —ç—Ç–∏ —ç–∫—Å–ø–æ—Ä—Ç—ã –∫—Ä–∏—Ç–∏—á–Ω—ã

### –ö–æ–Ω—Ü–µ–ø—Ç—É–∞–ª—å–Ω–æ

**–û–±—ã—á–Ω—ã–π SCF (1 wavefunction):**
```
wfn -> JK -> compute() -> form_G() -> converge
       ‚Üë
       –û–¥–∏–Ω –≤—ã–∑–æ–≤ jk.compute() –Ω–∞ –∏—Ç–µ—Ä–∞—Ü–∏—é
```

**Multi-cycle SCF (N wavefunctions):**
```
wfn1 ‚îÄ‚îÄ‚îê
wfn2 ‚îÄ‚îÄ‚îº‚îÄ‚îÄ> Shared JK -> compute() ONCE -> distribute J/K -> all form_G() -> converge
...    ‚îÇ                   ‚Üë
wfnN ‚îÄ‚îÄ‚îò                   –ï–î–ò–ù–°–¢–í–ï–ù–ù–´–ô –≤—ã–∑–æ–≤ jk.compute() –¥–ª—è –í–°–ï–• wfn!
```

**–ö–ª—é—á–µ–≤–∞—è –∏–¥–µ—è:** –í–º–µ—Å—Ç–æ N –≤—ã–∑–æ–≤–æ–≤ `jk.compute()` (–æ–¥–∏–Ω –Ω–∞ –∫–∞–∂–¥—ã–π wfn), –¥–µ–ª–∞–µ–º **–û–î–ò–ù** –æ–±—â–∏–π –≤—ã–∑–æ–≤ –¥–ª—è –≤—Å–µ—Ö wfn –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ. –≠—Ç–æ –¥–∞–µ—Ç speedup ~1.8-2x.

---

## –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç shared JK

### –ê–ª–≥–æ—Ä–∏—Ç–º multi_scf()

```python
# 1. –°–æ–±—Ä–∞—Ç—å –í–°–ï C –º–∞—Ç—Ä–∏—Ü—ã –æ—Ç –í–°–ï–• wfn
all_C_matrices = []
for wfn in wfn_list:
    C_matrices = wfn.get_orbital_matrices()  # [Ca_occ] –¥–ª—è RHF, [Ca_occ, Cb_occ] –¥–ª—è UHF
    all_C_matrices.extend(C_matrices)

# 2. –ü–µ—Ä–µ–¥–∞—Ç—å –∏—Ö –≤ shared JK
jk.C_left().clear()              # ‚Üê –¢–†–ï–ë–£–ï–¢ export C_left()
for C in all_C_matrices:
    jk.C_left().append(C)        # ‚Üê –¢–†–ï–ë–£–ï–¢ export C_left()

# 3. –ï–î–ò–ù–°–¢–í–ï–ù–ù–´–ô –≤—ã–∑–æ–≤ compute –¥–ª—è –í–°–ï–• wfn
jk.compute()

# 4. –ü–æ–ª—É—á–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
J_all = jk.J()                   # ‚Üê –£–∂–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ
K_all = jk.K()                   # ‚Üê –£–∂–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ

# 5. –†–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç—å J/K –æ–±—Ä–∞—Ç–Ω–æ –ø–æ wfn
for wfn in wfn_list:
    wfn.set_jk_matrices(J_list, K_list)  # Phase 0.6 API
```

---

## –ß—Ç–æ –±—ã–ª–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ export_fock.cc

### –î–æ (—Å—Ç—Ä–æ–∫–∏ 89-93):
```cpp
.def("C_left_add", [](JK &jk, SharedMatrix Cl) { jk.C_left().push_back(Cl); })
.def("C_right_add", [](JK &jk, SharedMatrix Cr) { jk.C_right().push_back(Cr); })
.def("J", &JK::J, py::return_value_policy::reference_internal)
.def("K", &JK::K, py::return_value_policy::reference_internal)
```

**–ü—Ä–æ–±–ª–µ–º–∞:** `C_left_add()` –¥–æ–±–∞–≤–ª—è–µ—Ç –ø–æ –æ–¥–Ω–æ–π –º–∞—Ç—Ä–∏—Ü–µ, –Ω–æ –Ω–µ—Ç —Å–ø–æ—Å–æ–±–∞ –æ—á–∏—Å—Ç–∏—Ç—å —Å–ø–∏—Å–æ–∫ (`clear()`)!

### –ü–æ—Å–ª–µ (—Å—Ç—Ä–æ–∫–∏ 89-101):
```cpp
.def("C_left_add", [](JK &jk, SharedMatrix Cl) { jk.C_left().push_back(Cl); })
.def("C_right_add", [](JK &jk, SharedMatrix Cr) { jk.C_right().push_back(Cr); })
.def("C_left",                                          // ‚Üê –ù–û–í–û–ï
     py::overload_cast<>(&JK::C_left),
     py::return_value_policy::reference_internal,
     "Returns the left orbital matrix list for multi-cycle JK computation.")
.def("C_right",                                         // ‚Üê –ù–û–í–û–ï
     py::overload_cast<>(&JK::C_right),
     py::return_value_policy::reference_internal,
     "Returns the right orbital matrix list for multi-cycle JK computation.")
.def("J", &JK::J, py::return_value_policy::reference_internal)
.def("K", &JK::K, py::return_value_policy::reference_internal)
```

**–†–µ—à–µ–Ω–∏–µ:** –¢–µ–ø–µ—Ä—å Python –º–æ–∂–µ—Ç –ø–æ–ª—É—á–∏—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ `std::vector<SharedMatrix>&` –∏ –≤—ã–∑–≤–∞—Ç—å `.clear()`, `.append()` –∏ —Ç.–¥.

---

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –°–∏–≥–Ω–∞—Ç—É—Ä—ã –≤ C++ (psi4/src/psi4/libfock/jk.h:531-555)

```cpp
class JK {
public:
    // –ú–µ—Ç–æ–¥—ã –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ C –º–∞—Ç—Ä–∏—Ü
    std::vector<SharedMatrix>& C_left() { return C_left_; }   // non-const ref
    std::vector<SharedMatrix>& C_right() { return C_right_; } // non-const ref

    // –ú–µ—Ç–æ–¥—ã –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    const std::vector<SharedMatrix>& J() const { return J_; }  // const ref
    const std::vector<SharedMatrix>& K() const { return K_; }  // const ref
};
```

### Pybind11 Policy

**`py::return_value_policy::reference_internal`** - –û–ë–Ø–ó–ê–¢–ï–õ–ï–ù –¥–ª—è –º–µ—Ç–æ–¥–æ–≤ –≤–æ–∑–≤—Ä–∞—â–∞—é—â–∏—Ö —Å—Å—ã–ª–∫–∏:
- –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —á—Ç–æ Python –¥–µ—Ä–∂–∏—Ç JK –æ–±—ä–µ–∫—Ç –∂–∏–≤—ã–º –ø–æ–∫–∞ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è C_left/J/K
- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç segfault –æ—Ç dangling references
- –ü–æ–∑–≤–æ–ª—è–µ—Ç –∏–∑–º–µ–Ω—è—Ç—å `std::vector<>` –∏–∑ Python (`.clear()`, `.append()`)

### –ß—Ç–æ —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ Python

```python
import psi4

# Setup JK...
jk = wfn.jk()

# –ü—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø –∫ –≤–µ–∫—Ç–æ—Ä–∞–º (–∫–∞–∫ –≤ C++)
c_left = jk.C_left()              # ‚úÖ –¢–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç
c_left.clear()                    # ‚úÖ –û—á–∏—Å—Ç–∏—Ç—å —Å–ø–∏—Å–æ–∫
c_left.append(C_occ1)             # ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –º–∞—Ç—Ä–∏—Ü—É 1
c_left.append(C_occ2)             # ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –º–∞—Ç—Ä–∏—Ü—É 2

jk.compute()

# –ü–æ–ª—É—á–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
J_all = jk.J()                    # ‚úÖ –£–∂–µ —Ä–∞–±–æ—Ç–∞–ª–æ
K_all = jk.K()                    # ‚úÖ –£–∂–µ —Ä–∞–±–æ—Ç–∞–ª–æ

print(len(J_all))                 # 2 (–¥–ª—è 2 wfn)
```

---

## –ü–æ—á–µ–º—É —ç—Ç–æ –∏–º–µ–Ω–Ω–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ, –∞ –Ω–µ "–∫–æ—Å—Ç—ã–ª—å"

1. **–≠—Ç–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Å–ø–æ—Å–æ–± –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è JK –≤ Psi4 C++ –∫–æ–¥–µ:**
   - –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –≤ `jk.h:141` —è–≤–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —ç—Ç–æ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω
   - –í—Å–µ C++ SCF –∫–æ–¥—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç `jk.C_left().clear()` –∏ `jk.C_left().push_back()`

2. **Shared JK —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏ –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω –±–µ–∑ –ø—Ä—è–º–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ –≤–µ–∫—Ç–æ—Ä–∞–º:**
   - –ù—É–∂–Ω–æ —Å–æ–±—Ä–∞—Ç—å C –æ—Ç –í–°–ï–• wfn –≤ –æ–¥–∏–Ω —Å–ø–∏—Å–æ–∫
   - –ù—É–∂–Ω–æ –æ—á–∏—Å—Ç–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø–µ—Ä–µ–¥ –∫–∞–∂–¥–æ–π –∏—Ç–µ—Ä–∞—Ü–∏–µ–π
   - `C_left_add()` –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ (–Ω–µ—Ç `clear()`)

3. **Phase 0.6 API –¥–µ–ª–∞–µ—Ç —ç—Ç–æ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ —á–∏—Å—Ç—ã–º:**
   - `wfn.get_orbital_matrices()` - —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –∫–æ–ª–ª–µ–∫—Ü–∏—è C
   - `jk.C_left()` - —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
   - `wfn.set_jk_matrices()` - —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ
   - **–ù–µ—Ç —è–≤–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–∏–ø–æ–≤** (if RHF/UHF/ROHF)

4. **–≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç SA-REKS:**
   - SA-REKS: –æ–¥–∏–Ω wfn, –Ω–æ N —Å–æ—Å—Ç–æ—è–Ω–∏–π (N > 2)
   - `wfn.n_states()` –≤–µ—Ä–Ω–µ—Ç N
   - `wfn.get_orbital_matrices()` –≤–µ—Ä–Ω–µ—Ç N –º–∞—Ç—Ä–∏—Ü
   - –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —É–∂–µ –≥–æ—Ç–æ–≤–∞ –¥–ª—è —ç—Ç–æ–≥–æ!

---

## –†–µ–∑—é–º–µ

| –í–æ–ø—Ä–æ—Å | –û—Ç–≤–µ—Ç |
|--------|-------|
| –≠—Ç–æ –æ—à–∏–±–∫–∞ —Å –Ω–∞—à–µ–π —Å—Ç–æ—Ä–æ–Ω—ã? | **–ù–ï–¢** |
| –≠—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–ª—è multi-cycle SCF? | **–î–ê, –∞–±—Å–æ–ª—é—Ç–Ω–æ** |
| –ú–æ–∂–Ω–æ –ª–∏ –±–µ–∑ —ç—Ç–æ–≥–æ? | **–ù–ï–¢, —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ** |
| –≠—Ç–æ "–∫–æ—Å—Ç—ã–ª—å"? | **–ù–ï–¢, —ç—Ç–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω Psi4** |
| –≠—Ç–æ forward-compatible —Å SA-REKS? | **–î–ê, –ø–æ–ª–Ω–æ—Å—Ç—å—é** |

**–í—ã–≤–æ–¥:** –≠—Ç–∏ —ç–∫—Å–ø–æ—Ä—Ç—ã - **–Ω–µ–æ–±—Ö–æ–¥–∏–º–∞—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞** –¥–ª—è multi-cycle SCF, –∞ –Ω–µ "–¥–æ—Ä–∞–±–æ—Ç–∫–∞" –∏–ª–∏ "—Ñ–∏–∫—Å". –ë–µ–∑ –Ω–∏—Ö shared JK computation —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏ –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω.

---

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã —ç–∫—Å–ø–æ—Ä—Ç—ã `C_left()` –∏ `C_right()` –≤ `export_fock.cc`
2. ‚è≥ Rebuild C++: `ninja -j4` –≤ build directory
3. ‚è≥ –¢–µ—Å—Ç: `python test_multi_scf.py`
4. ‚è≥ –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: **Phase 1 COMPLETE!** üöÄ
