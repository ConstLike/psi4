#! Multi-SCF test: RHF and UHF wavefunctions on water molecule
#! Tests that multi_scf gives identical results to sequential SCF

import psi4
from psi4.driver.procrouting.proc import scf_wavefunction_factory
from psi4.driver.procrouting.scf_proc.scf_iterator import multi_scf

# Reference values (from sequential SCF calculations with PK integrals)
ref_rhf_h2o =  -76.0266536619  #TEST
ref_uhf_h2o =  -76.0266536619  #TEST

# Water molecule
molecule h2o {
0 1
O
H 1 0.96
H 1 0.96 2 104.5
symmetry c1
}

set {
    basis cc-pvdz
    scf_type pk
    e_convergence 10
    d_convergence 8
}

# Create base wavefunction
wfn_base = psi4.core.Wavefunction.build(h2o, psi4.core.get_global_option('BASIS'))

# Create RHF wavefunction using factory
wfn_rhf = scf_wavefunction_factory('hf', wfn_base, 'RHF')
wfn_rhf.set_wfn_name("rhf")

# Create UHF wavefunction using factory
wfn_uhf = scf_wavefunction_factory('hf', wfn_base, 'UHF')
wfn_uhf.set_wfn_name("uhf")

# Run multi_scf with both wavefunctions
energies = multi_scf([wfn_rhf, wfn_uhf])

compare_values(ref_rhf_h2o, energies[0], 8, "RHF H2O energy from multi_scf")  #TEST
compare_values(ref_uhf_h2o, energies[1], 8, "UHF H2O energy from multi_scf")  #TEST

# Verify energies match (singlet UHF should = RHF for closed-shell)
compare_values(energies[0], energies[1], 10, "RHF vs UHF energies for closed-shell singlet")  #TEST
